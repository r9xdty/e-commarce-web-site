@model List<CategoriesWithProducts.UI.Models.DTO.CategoryDto>

@{
	ViewData["Title"] = "Categories";
	var isAuthorized = User.IsInRole("Admin") || User.IsInRole("Writer");
}

<div class="container mt-5">
	<h1>Kategoriler</h1>

	<!-- Buton için alan -->
	<div id="categoryControls" class="mb-3"></div>

	<table class="table table-bordered">
		<thead>
			<tr>
				<th>Category Name</th>
				<th>TotalPrice</th>
				@if (isAuthorized)
				{
					<th>Operations</th>
				}
			</tr>
		</thead>
		<tbody id="categoryTableBody">
			@foreach (var category in Model)
			{
				<tr data-id="@category.Id" data-name="@category.Name">
					<td>
						<a asp-controller="Product" asp-action="Index" asp-route-id="@category.Id"
						   class="btn btn-light">@category.Name</a>
					</td>
					<td>@category.TotalPrice</td>
					@if (isAuthorized)
					{
						<td class="operation-buttons">
							<!-- JS ile doldurulacak -->
						</td>
					}
				</tr>
			}
		</tbody>
	</table>
</div>

<!-- Modal -->
<div class="modal fade" id="categoryModal" tabindex="-1">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title">Category Add/Edit</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
			</div>
			<div class="modal-body">
				<form id="categoryForm">
					<input type="hidden" id="categoryId">
					<div class="mb-3">
						<label for="categoryName" class="form-label">Category Name</label>
						<input type="text" id="categoryName" class="form-control" required>
					</div>
				</form>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
				<button type="button" id="saveCategory" class="btn btn-primary">Save</button>
			</div>
		</div>
	</div>
</div>

<script>
	$(document).ready(function () {
		const userIsAuthorized = @isAuthorized.ToString().ToLower();

		// Add Category butonu
		if (userIsAuthorized) {
			$('#categoryControls').append('<button class="btn btn-primary" id="btnAddCategory">Add Category</button>');
		}

		// Edit & Delete butonlarını tabloya ekle
		if (userIsAuthorized) {
			$('#categoryTableBody tr').each(function () {
				const id = $(this).data('id');
				const buttons = `
					<button class="btn btn-success btnEdit me-1" data-id="${id}">Edit</button>
					<button class="btn btn-danger btnDelete" data-id="${id}">Delete</button>
				`;
				$(this).find('.operation-buttons').html(buttons);
			});
		}

		// Add Category click
		$(document).on('click', '#btnAddCategory', function () {
			$('#categoryId').val('');
			$('#categoryName').val('');
			$('#categoryModal').modal('show');
		});

		// Edit click
		$(document).on('click', '.btnEdit', function () {
			let id = $(this).data('id');
			$.ajax({
				url: `/Categories/EditCategory/${id}`,
				type: 'GET',
				success: function (data) {
					$('#categoryId').val(data.id);
					$('#categoryName').val(data.name);
					$('#categoryModal').modal('show');
				},
				error: function () {
					toastr.error("Couldn't access category information!");
				}
			});
		});

		// Delete click
		$(document).on('click', '.btnDelete', function () {
			let id = $(this).data('id');
			if (confirm("Are you sure to delete this category?")) {
				$.ajax({
					url: `/Categories/DeleteCategory/${id}`,
					type: 'POST',
					success: function (response) {
						if (response.success) {
							toastr.success("Category deleted successfuly.");
							location.reload();
						} else {
							toastr.error("Category couldn't deleted.");
						}
					},
					error: function () {
						toastr.error("There is an error in the process!");
					}
				});
			}
		});

		// Save click
		$('#saveCategory').click(function () {
			let data = {
				Id: $('#categoryId').val(),
				Name: $('#categoryName').val()
			};

			let url = data.Id ? '/Categories/EditCategory' : '/Categories/AddCategory';

			$.ajax({
				url: url,
				type: 'POST',
				contentType: 'application/json',
				data: JSON.stringify(data),
				success: function (response) {
					if (response.success) {
						toastr.success("Category saved successfuly.");
						$('#categoryModal').modal('hide');
						location.reload();
					} else {
						toastr.error("Category couldn't save!");
					}
				},
				error: function () {
					toastr.error("There is an error in the process!");
				}
			});
		});
	});
</script>
